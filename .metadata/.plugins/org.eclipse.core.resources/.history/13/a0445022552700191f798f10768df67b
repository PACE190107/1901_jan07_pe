package com.revature.dao;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import org.apache.log4j.Logger;
import oracle.jdbc.*;

import com.revature.data.DataSource;
import com.revature.exception.EmployeeNotFoundException;
import com.revature.model.Todo;
import com.revature.models.Employee;
import com.revature.util.ERSConnectionUtil;

import oracle.jdbc.OracleTypes;

public class EmployeeDaoImpl implements EmployeeDao {

	final static Logger log = Logger.getLogger(EmployeeDaoImpl.class);
	private final DataSource dataSource = DataSource.getInstance();
	
	// SELECT * FROM EMPLOYEE;
	@Override
	public List<Employee> getAllEmployees() {
		return dataSource.getEmployeeTable();
	}

	// SELECT * FROM EMPLOYEE WHERE ID = ?;
	@Override
	public Employee getEmployeeById(int id) {
		
		return dataSource.getEmployeeTable().stream()
					.filter(todo -> todo.getId() == id)
					.findFirst().orElseThrow(() -> new EmployeeNotFoundException(id));
	}
	
	@Override
	public Employee updateEmployee(Employee employee) {
		// Get a reference to existing Employee
		Employee updated = getEmployeeById(employee.getId());
		
		// Update the todo's state
		updated.setFirstname(employee.getFirstname());
		updated.setLastname(employee.getLastname());
		updated.setAddress(employee.getAddress());
		updated.setEmail(employee.getEmail());
		updated.setUsername(updated.getUsername());
		updated.setPassword(employee.getPassword());
		// Store the updated version
		for (int i = 0; i < dataSource.getEmployeeTable().size(); i++) {
			if (dataSource.getEmployeeTable().get(i).getId() == employee.getId()) {
				dataSource.getEmployeeTable().set(i, updated);
				return updated;
			}
		}
		return null;
	}

	@Override
	public Employee updateEmployee(int id) {
		Employee updated = getEmployeeById(id);
		try (Connection conn = ERSConnectionUtil.getConnection()) {	
			String sql = "call GET_EMP_INFO(?,?)";
			CallableStatement cs = conn.prepareCall(sql);
			cs.setInt(1, id);
			cs.registerOutParameter(2, OracleTypes.CURSOR);
			cs.execute();
			ResultSet rs = ((OracleCallableStatement)cs).getCursor(2);
			if (rs.next() == false) {
				throw new EmployeeNotFoundException(id);
			} else {
				updated.setId(rs.getInt("EMP_ID"));
				updated.setFirstname(rs.getString("EMP_FNAME"));
				updated.setLastname(rs.getString("EMP_LNAME"));
				updated.setAddress(rs.getString("EMP_ADDR"));
				updated.setEmail(rs.getString("EMP_EMAIL"));
				updated.setUsername(rs.getString("EMP_UNAME"));
				updated.setPassword(rs.getString("EMP_PASS"));
				updated.setIsManager(rs.getInt("EMP_ISMGR"));
				return updated;
			}
		} catch (SQLException e) {
			log.error("error occured in updateemployee method");
		}
		return null;
	}
	
	@Override
	public Employee deleteEmployee(int id) {
		Employee toBeRemoved = getEmployeeById(id);
		try (Connection conn = ERSConnectionUtil.getConnection()) {	
			int deleteSuccessful = 0;
			String sql = "call DELETE_BANK_CHECK(?,?)";
			CallableStatement cs = conn.prepareCall(sql);
			cs.setInt(1, id);
			cs.registerOutParameter(2, java.sql.Types.NUMERIC);
			cs.executeUpdate();
			deleteSuccessful = deleteSuccessful + cs.getInt(2);
			sql = "call DELETE_BANK_SAVE(?,?)";
			cs = conn.prepareCall(sql);
			cs.setInt(1, id);
			cs.registerOutParameter(2, java.sql.Types.NUMERIC);
			cs.executeUpdate();
			deleteSuccessful = deleteSuccessful + cs.getInt(2);
		return toBeRemoved;
		} catch (SQLException e) {
			log.error("error occured in deleteemployee method");
		}
		return null;
	}

}